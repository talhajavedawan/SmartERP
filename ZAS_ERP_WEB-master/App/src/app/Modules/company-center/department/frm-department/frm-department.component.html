<div class="button-space">
  <!-- Close button -->
  <button
    type="button"
    class="btn-close close-button"
    aria-label="Close"
    (click)="closeModal()"
  ></button>

  <form [formGroup]="departmentForm">
    <nz-tabset [(nzSelectedIndex)]="selectedTabIndex">
      <!-- =================== DEPARTMENT INFO =================== -->
      <nz-tab nzTitle="Department Info">
        <div class="tab-content">
          <h6 class="section-title">
            <i class="bi bi-info-circle-fill text-primary me-2"></i>
            Department Information
          </h6>

          <!-- Row 1 -->
          <div class="row g-3">
            <!-- Department Name -->
            <div class="col-md-3">
              <label class="form-label">
                Department Name <span class="text-danger">*</span>
              </label>
              <input
                type="text"
                class="form-control"
                formControlName="deptName"
                placeholder="Enter Department Name"
                [class.is-invalid]="
                  departmentForm.get('deptName')?.invalid &&
                  departmentForm.get('deptName')?.touched
                "
              />
              @if (departmentForm.get('deptName')?.invalid &&
              departmentForm.get('deptName')?.touched) {
              <div class="invalid-feedback">
                Please enter a valid Department Name
              </div>
              }
            </div>

            <!-- Department Code -->
            <div class="col-md-3">
              <label class="form-label">
                Department Code <span class="text-danger">*</span>
              </label>
              <input
                type="text"
                class="form-control"
                formControlName="deptCode"
                placeholder="Enter Code"
                [class.is-invalid]="
                  departmentForm.get('deptCode')?.invalid &&
                  departmentForm.get('deptCode')?.touched
                "
              />
              @if (departmentForm.get('deptCode')?.invalid &&
              departmentForm.get('deptCode')?.touched) {
              <div class="invalid-feedback">
                Please enter a valid Department Code
              </div>
              }
            </div>

            <div class="col-md-3">
              <label class="form-label">Abbreviation</label>
              <input
                type="text"
                class="form-control"
                formControlName="abbreviation"
                placeholder="Enter Abbreviation"
              />
            </div>

            <!-- Replace the old datetime inputs with this block -->
            <div class="row g-3 mt-2">
              @if (departmentId && originalDepartment) {
              <!-- EDIT MODE: Show full audit trail -->
              <div class="col-md-3">
                <label class="form-label">Created By</label>
                <input
                  type="text"
                  class="form-control"
                  [value]="originalDepartment.createdByUserName || 'â€”'"
                  readonly
                />
              </div>

              <div class="col-md-3">
                <label class="form-label">Creation Date</label>
                <input
                  type="text"
                  class="form-control"
                  [value]="formatPKTDate(originalDepartment.createdDate)"
                  readonly
                />
              </div>

              <div class="col-md-3">
                <label class="form-label">Last Modified By</label>
                <input
                  type="text"
                  class="form-control"
                  [value]="originalDepartment.lastModifiedByUserName || 'â€”'"
                  readonly
                />
              </div>

              <div class="col-md-3">
                <label class="form-label">Last Modified</label>
                <input
                  type="text"
                  class="form-control"
                  [value]="
                    originalDepartment.lastModifiedDate
                      ? formatPKTDate(originalDepartment.lastModifiedDate)
                      : 'â€”'
                  "
                  readonly
                />
              </div>
              }
            </div>
          </div>

          <!-- Row 2 -->
          <div class="row g-3 mt-2">
            <!-- Is Active -->
            <div class="col-md-3 form-check mt-4">
              <div class="form-check form-switch">
                <input
                  type="checkbox"
                  class="form-check-input"
                  formControlName="isActive"
                  id="isActive"
                  [disabled]="isLoading"
                />
                <label for="isActive" class="form-check-label">Active</label>
              </div>
            </div>

            <!-- Is Subsidiary -->
            <div class="col-md-3 form-check mt-4">
              <input
                type="checkbox"
                class="form-check-input"
                formControlName="isSubsidiary"
                id="isSubsidiary"
                (change)="toggleSubsidiary($event)"
              />
              <label for="isSubsidiary" class="form-check-label"
                >Subsidiary</label
              >
            </div>

            @if (showParentDropdown) {
            <div class="col-md-3">
              <label class="form-label">Parent Department</label>
              <nz-tree-select
                formControlName="parentDepartmentId"
                [nzNodes]="departmentTreeNodes"
                nzShowSearch
                nzPlaceHolder="Select Parent Department"
                nzAllowClear
                [nzDropdownStyle]="{ 'max-height': '300px' }"
                class="w-100"
              >
              </nz-tree-select>
            </div>
            }
          </div>
        </div>
      </nz-tab>
      <!-- =================== COMPANIES =================== -->
      <nz-tab nzTitle="Companies">
        <div class="tab-fullscreen d-flex flex-column">
          <div class="flex-fill">
            <div class="row g-4 h-100">
              <!-- All Companies -->
              <div class="col-6 h-100">
                <div class="modern-card shadow-sm border-0 p-3 h-100">
                  <h6 class="fw-semibold mb-3 text-secondary">Companies</h6>
                  <input
                    type="text"
                    class="form-control form-control-modern mb-3"
                    placeholder="ðŸ” Search companies..."
                    [value]="companySearch"
                    (input)="
                      companySearch = $any($event.target).value;
                      filterCompanies()
                    "
                  />
                  <ul
                    class="list-group modern-list flex-grow-1 overflow-auto h-100"
                  >
                    @for (company of filteredCompanies; track company.id) {
                    <li
                      class="list-group-item list-group-item-action modern-item"
                      (click)="addCompany(company)"
                    >
                      {{ company.companyName }}
                    </li>
                    } @if (filteredCompanies.length === 0) {
                    <li class="list-group-item text-muted text-center py-3">
                      No companies available
                    </li>
                    }
                  </ul>
                </div>
              </div>

              <!-- Selected Companies -->
              <div class="col-6 h-100">
                <div class="modern-card shadow-sm border-0 p-3 h-100">
                  <h6 class="fw-semibold mb-3 text-secondary">
                    Selected Companies
                  </h6>
                  <ul
                    class="list-group modern-list flex-grow-1 overflow-auto h-100"
                  >
                    @for (company of selectedCompanies; track company.id) {
                    <li
                      class="list-group-item d-flex justify-content-between align-items-center modern-item"
                    >
                      <span class="fw-medium">{{ company.companyName }}</span>
                      <button
                        class="btn btn-sm btn-outline-danger rounded-circle"
                        (click)="removeCompany(company, $event)"
                        type="button"
                        aria-label="Remove"
                      >
                        &times;
                      </button>
                    </li>
                    } @if (selectedCompanies.length === 0) {
                    <li class="list-group-item text-muted text-center py-3">
                      No companies selected
                    </li>
                    }
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </nz-tab>

      <!-- =================== EMPLOYEES =================== -->
      <nz-tab nzTitle="Employees">
        <div class="tab-fullscreen d-flex flex-column">
          <div class="flex-fill">
            <div class="row g-4 h-100">
              <!-- All Employees -->
              <div class="col-6 h-100">
                <div class="modern-card shadow-sm border-0 p-3 h-100">
                  <h6 class="fw-semibold mb-3 text-secondary">Employees</h6>
                  <input
                    type="text"
                    class="form-control form-control-modern mb-3"
                    placeholder="ðŸ” Search employees..."
                    [value]="employeeSearch"
                    (input)="
                      employeeSearch = $any($event.target).value;
                      filterEmployees()
                    "
                  />
                  <ul
                    class="list-group modern-list flex-grow-1 overflow-auto h-100"
                  >
                    @for (employee of filteredEmployees; track employee.id) {
                    <li
                      class="list-group-item list-group-item-action modern-item"
                      (click)="addEmployee(employee)"
                    >
                      {{ employee.systemDisplayName }}
                    </li>
                    } @if (filteredEmployees.length === 0) {
                    <li class="list-group-item text-muted text-center py-3">
                      No employees available
                    </li>
                    }
                  </ul>
                </div>
              </div>

              <!-- Selected Employees -->
              <div class="col-6 h-100">
                <div class="modern-card shadow-sm border-0 p-3 h-100">
                  <h6 class="fw-semibold mb-3 text-secondary">
                    Selected Employees
                  </h6>
                  <ul
                    class="list-group modern-list flex-grow-1 overflow-auto h-100"
                  >
                    @for (employee of selectedEmployees; track employee.id) {
                    <li
                      class="list-group-item d-flex justify-content-between align-items-center modern-item"
                    >
                      <span class="fw-medium">{{
                        employee.systemDisplayName
                      }}</span>
                      <button
                        class="btn btn-sm btn-outline-danger rounded-circle"
                        (click)="removeEmployee(employee, $event)"
                        type="button"
                        aria-label="Remove"
                      >
                        &times;
                      </button>
                    </li>
                    } @if (selectedEmployees.length === 0) {
                    <li class="list-group-item text-muted text-center py-3">
                      No employees selected
                    </li>
                    }
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </nz-tab>
    </nz-tabset>
  </form>
</div>

<!-- =================== FOOTER SAVE BAR =================== -->
<div class="footer-bar" (click)="saveDepartment()">
  @if (!isLoading && departmentForm.valid) {
  <span>
    <i class="bi {{ departmentId ? 'bi-pencil-square' : 'bi-save' }} me-2"></i>
    {{ departmentId ? "Update Department" : "Save Department" }}
  </span>
  } @if (isLoading) {
  <span>
    <span class="spinner-border spinner-border-sm me-2"></span>
    Saving...
  </span>
  } @if (departmentForm.invalid && !isLoading) {
  <span class="opacity-75">
    <i class="bi bi-exclamation-triangle me-2"></i>
    Please fill all required fields
  </span>
  }
</div>

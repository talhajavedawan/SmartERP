<div class="button-space">
  <button
    type="button"
    class="btn-close close-button"
    aria-label="Close"
    (click)="closeModal()"
  ></button>

  <!-- HEADER -->
  <div
    class="header border-bottom mb-3 d-flex justify-content-between align-items-center"
  >
    <div class="d-flex gap-3 align-items-center">
      <i class="bi bi-person-fill text-primary me-2"></i>
      <strong>{{ userForm.get("userName")?.value || "New User" }}</strong>
    </div>
  </div>

  <!-- BODY -->
  <div class="card-body">
    <form [formGroup]="userForm" (ngSubmit)="onSubmit()" autocomplete="off">
      <h5 class="section-title">
        <i class="bi bi-person-fill me-2 text-primary"></i> User Info
      </h5>

      <div class="row g-3">
        <!-- USER NAME -->
        <div class="col-md-4">
          <label class="form-label">
            User Name <span class="text-danger">*</span>
          </label>
          <input
            type="text"
            class="form-control"
            formControlName="userName"
            placeholder="Enter User Name"
            autocomplete="off"
            name="new-username-{{ randomId }}"
            [attr.data-autocomplete]="isEdit ? 'off' : 'new-username'"
            [class.is-invalid]="
              userForm.get('userName')?.invalid &&
              userForm.get('userName')?.touched
            "
          />
          @if (userForm.get('userName')?.touched &&
          userForm.get('userName')?.hasError('required')) {
          <div class="invalid-feedback">User Name is required.</div>
          }
        </div>

        <!-- PASSWORD -->
        <div class="col-md-4 position-relative">
          <label class="form-label">
            Password <span class="text-danger" *ngIf="!isEdit">*</span>
            <i
              class="bi bi-info-circle ms-1 text-primary"
              data-bs-toggle="tooltip"
              data-bs-placement="right"
              title="Password must contain at least:
One uppercase letter
One lowercase letter
One digit
One special character
Minimum length of 6 characters"
            ></i>
          </label>

          <div class="input-group">
            <input
              [type]="passwordVisible ? 'text' : 'password'"
              class="form-control"
              formControlName="password"
              [placeholder]="
                isEdit ? 'Leave blank to keep current' : 'Enter Password'
              "
              autocomplete="new-password"
              name="new-password-{{ randomId }}"
              [attr.data-autocomplete]="isEdit ? 'off' : 'new-password'"
              [class.is-invalid]="
                userForm.get('password')?.invalid &&
                (userForm.get('password')?.touched ||
                  userForm.get('password')?.dirty)
              "
            />
            <button
              type="button"
              class="btn btn-outline-secondary"
              (click)="togglePasswordVisibility('password')"
            >
              <i
                class="bi"
                [ngClass]="passwordVisible ? 'bi-eye-slash' : 'bi-eye'"
              ></i>
            </button>
          </div>

          <!-- Always show errors as block -->
          <div
            *ngIf="
              userForm.get('password')?.invalid &&
              (userForm.get('password')?.touched ||
                userForm.get('password')?.dirty)
            "
          >
            <div
              *ngIf="userForm.get('password')?.hasError('required')"
              class="invalid-feedback d-block"
            >
              Password is required.
            </div>
            <div
              *ngIf="userForm.get('password')?.hasError('passwordStrength')"
              class="invalid-feedback d-block"
            >
              Password must include uppercase, lowercase, digit special
              character and atleast 6 characters.
            </div>
          </div>
        </div>

        <!-- CONFIRM PASSWORD -->
        <div class="col-md-4">
          <label class="form-label">
            Confirm Password <span class="text-danger" *ngIf="!isEdit">*</span>
          </label>
          <div class="input-group">
            <input
              [type]="confirmPasswordVisible ? 'text' : 'password'"
              class="form-control"
              formControlName="confirmPassword"
              [placeholder]="
                isEdit ? 'Leave blank to keep current' : 'Confirm Password'
              "
              [class.is-invalid]="
                (userForm.get('confirmPassword')?.invalid ||
                  userForm.hasError('mismatch')) &&
                (userForm.get('confirmPassword')?.touched ||
                  userForm.get('confirmPassword')?.dirty)
              "
            />
            <button
              type="button"
              class="btn btn-outline-secondary"
              (click)="togglePasswordVisibility('confirmPassword')"
            >
              <i
                class="bi"
                [ngClass]="confirmPasswordVisible ? 'bi-eye-slash' : 'bi-eye'"
              ></i>
            </button>
          </div>

          <div
            *ngIf="
              (userForm.get('confirmPassword')?.invalid ||
                userForm.hasError('mismatch')) &&
              (userForm.get('confirmPassword')?.touched ||
                userForm.get('confirmPassword')?.dirty)
            "
          >
            <div
              *ngIf="userForm.get('confirmPassword')?.hasError('required')"
              class="invalid-feedback d-block"
            >
              Confirm Password is required.
            </div>
            <div
              *ngIf="userForm.hasError('mismatch')"
              class="invalid-feedback d-block"
            >
              Passwords do not match.
            </div>
          </div>
        </div>
        <!-- After User Name, before Password -->
        <div class="col-md-4">
          <label class="form-label">
            Email <span class="text-danger">*</span>
          </label>
          <input
            type="email"
            class="form-control"
            formControlName="email"
            placeholder="Enter Email"
            autocomplete="off"
            [class.is-invalid]="
              userForm.get('email')?.invalid && userForm.get('email')?.touched
            "
          />
          @if (userForm.get('email')?.touched &&
          userForm.get('email')?.hasError('required')) {
          <div class="invalid-feedback">Email is required.</div>
          } @if (userForm.get('email')?.touched &&
          userForm.get('email')?.hasError('email')) {
          <div class="invalid-feedback">Enter a valid email.</div>
          }
        </div>
        <!-- EMPLOYEE -->
        <div class="col-md-12">
          <label class="form-label"> Employee </label>
          <nz-select
            formControlName="employeeId"
            nzPlaceHolder="Select Employee"
            class="form-control"
            [nzDropdownRender]="employeeDropdown"
            [nzShowSearch]="true"
            [nzDropdownStyle]="{ 'min-width': '100%', 'z-index': '2000' }"
            [class.is-invalid]="
              userForm.get('employeeId')?.invalid &&
              userForm.get('employeeId')?.touched
            "
          >
            <nz-option
              *ngFor="let emp of employees"
              [nzValue]="emp.id"
              [nzLabel]="emp.person?.firstName + ' ' + emp.person?.lastName"
            ></nz-option>
          </nz-select>

          <ng-template #employeeDropdown>
            <div class="card" style="max-height: 300px; overflow: auto">
              <div class="table-responsive">
                <table class="table table-hover table-sm mb-0">
                  <thead class="table-light sticky-top">
                    <tr>
                      <th>First Name</th>
                      <th>Last Name</th>
                      <th>CNIC</th>
                      <th>Phone</th>
                      <th>Hire Date</th>
                      <th>Join Date</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr
                      *ngFor="let emp of employees"
                      (click)="selectEmployee(emp)"
                      class="cursor-pointer"
                    >
                      <td>{{ emp.person?.firstName || "—" }}</td>
                      <td>{{ emp.person?.lastName || "—" }}</td>
                      <td>{{ emp.person?.cnic || "—" }}</td>
                      <td>{{ emp.contact?.phoneNumber || "—" }}</td>
                      <td>
                        {{ emp.hireDate ? formatPKTDate(emp.hireDate) : "—" }}
                      </td>
                      <td>
                        {{ emp.joinDate ? formatPKTDate(emp.joinDate) : "—" }}
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </ng-template>
        </div>

        <!-- ROLES -->
        <div class="col-12">
          <label class="form-label">
            Roles <span class="text-danger">*</span>
          </label>

          <nz-table
            #roleTable
            [nzData]="flatRoles"
            nzBordered
            [nzFrontPagination]="false"
            [nzShowPagination]="false"
            nzTableLayout="fixed"
            class="table"
          >
            <thead>
              <tr>
                <th style="width: 60%">Role</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              @for (role of roleTable.data; track role.key) {
              <tr
                [class.ant-table-row-selected]="
                  userForm.get('roles')?.value.includes(role.key)
                "
              >
                <td>
                  <div
                    class="d-flex align-items-center"
                    [style.padding-left.px]="role.level * 20"
                  >
                    <!-- Expand/Collapse Icon -->
                    <i
                      *ngIf="role.isParent"
                      class="bi me-2 cursor-pointer"
                      [ngClass]="{
                        'bi-caret-down-fill': expandedRoleIds.has(role.key),
                        'bi-caret-right-fill': !expandedRoleIds.has(role.key)
                      }"
                      (click)="
                        onExpandChange(role, !expandedRoleIds.has(role.key))
                      "
                    ></i>

                    <!-- Spacer for child roles -->
                    <span *ngIf="!role.isParent" style="width: 1.2rem"></span>

                    <!-- Checkbox and title -->
                    <label class="ms-1 mb-0 d-flex align-items-center gap-2">
                      <input
                        type="checkbox"
                        class="form-check-input"
                        [checked]="
                          userForm.get('roles')?.value.includes(role.key)
                        "
                        (change)="onRoleCheckChange($event, role.key)"
                      />
                      <span>{{ role.title }}</span>
                    </label>
                  </div>
                </td>
                <td>{{ role.description || "-" }}</td>
              </tr>
              } @if (flatRoles.length === 0) {
              <tr>
                <td colspan="2" class="text-center">No roles found</td>
              </tr>
              }
            </tbody>
          </nz-table>

          <!-- ROLES VALIDATION -->
          @if (userForm.get('roles')?.touched &&
          userForm.get('roles')?.hasError('required')) {
          <div class="invalid-feedback d-block">
            At least one role is required.
          </div>
          }
        </div>

        <!-- ACTIVE SWITCH -->
        <div class="col-md-3 d-flex align-items-center mt-4">
          <div class="form-check form-switch">
            <input
              class="form-check-input"
              type="checkbox"
              id="isActive"
              formControlName="isActive"
            />
            <label class="form-check-label" for="isActive">Active</label>
          </div>
        </div>
      </div>

      <!-- FOOTER -->
      <div
        class="footer-bar"
        (click)="userForm.valid && !isLoading && onSubmit()"
      >
        @if (!isLoading && userForm.valid) {
        <i class="bi {{ isEdit ? 'bi-pencil-square' : 'bi-save' }} me-2"></i>
        {{ isEdit ? "Update" : "Save" }}
        } @else if (isLoading) {
        <span class="spinner-border spinner-border-sm me-2"></span> Saving... }
        @else { <i class="bi bi-exclamation-triangle me-2"></i> Please fill all
        required fields }
      </div>
    </form>
  </div>
</div>

<div *ngIf="alert.message" class="alert-container" [ngClass]="{
  'alert-success': alert.type === 'success',
  'alert-error': alert.type === 'error',
  'alert-warning': alert.type === 'warning'
}">
  <i class="bi" [ngClass]="{
    'bi-check-circle-fill': alert.type === 'success',
    'bi-exclamation-triangle-fill': alert.type === 'warning',
    'bi-x-circle-fill': alert.type === 'error'
  }"></i>
  <span class="alert-message">{{ alert.message }}</span>
  <button type="button" class="alert-close" (click)="alert = { type: '', message: '' }">Ã—</button>
</div>

<div class="button-space">
  <button type="button" class="btn-close close-button" aria-label="Close" (click)="closeModal()"></button>

  <div class="card-body">
    <form [formGroup]="registrationForm" (ngSubmit)="saveVendor()" novalidate>
      <nz-tabset [(nzSelectedIndex)]="selectedIndex">

        <nz-tab nzTitle="Vendor Information">
          <div class="tab-content">
            <h5 class="section-title">
              <i class="bi bi-building-fill me-2 text-primary"></i> Vendor Company Details
            </h5>

            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Vendor Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control" formControlName="VendorName"
                  placeholder="Enter Vendor / Company Name"
                  [class.is-invalid]="registrationForm.get('VendorName')?.invalid && registrationForm.get('VendorName')?.touched" />
                @if (registrationForm.get('VendorName')?.invalid && registrationForm.get('VendorName')?.touched) {
                <div class="invalid-feedback">Vendor name is required (min 3 characters)</div>
                }
              </div>

              <div class="col-md-4">
                <label class="form-label">NTN</label>
                <input type="text" class="form-control" formControlName="Ntn" placeholder="Enter NTN" />
              </div>

              <div class="col-md-4">
                <label class="form-label">Registration Number</label>
                <input type="text" class="form-control" formControlName="RegistrationNumber"
                  placeholder="Enter Registration Number" />
              </div>
            </div>

            <!-- Row 2: Industry, Business, Vendor Nature -->
            <div class="row g-3 mt-2">
              <div class="col-md-4">
                <label class="form-label">Industry Type <span class="text-danger">*</span></label>
                <nz-select formControlName="IndustryTypeId" nzPlaceHolder="Select Industry Type" class="w-100">
                  <nz-option *ngFor="let i of industryTypes" [nzValue]="i.id"
                    [nzLabel]="i.industryTypeName"></nz-option>
                </nz-select>
              </div>

              <div class="col-md-4">
                <label class="form-label">Business Type <span class="text-danger">*</span></label>
                <nz-select formControlName="BusinessTypeId" nzPlaceHolder="Select Business Type" class="w-100">
                  <nz-option *ngFor="let b of businessTypes" [nzValue]="b.id"
                    [nzLabel]="b.businessTypeName"></nz-option>
                </nz-select>
              </div>

              <div class="col-md-4">
                <label class="form-label">Vendor Nature <span class="text-danger">*</span></label>
                <nz-select formControlName="VendorNatureId" nzPlaceHolder="Select Vendor Nature" class="w-100">
                  <nz-option *ngFor="let n of vendorNatures" [nzValue]="n.id" [nzLabel]="n.name"></nz-option>
                </nz-select>
              </div>
            </div>

            <!-- Row 3: Currency, Flags, Ranking -->
            <div class="row g-3 mt-3">
              <div class="col-md-4">
                <label class="form-label">Currency <span class="text-danger">*</span></label>
                <nz-select formControlName="CurrencyId" nzPlaceHolder="Select Currency" class="w-100">
                  <nz-option *ngFor="let c of currencies" [nzValue]="c.id" [nzLabel]="c.name"></nz-option>
                </nz-select>
              </div>

              <div class="col-md-2 d-flex align-items-center">
                <div class="form-check form-switch">
                  <input type="checkbox" class="form-check-input" id="IsActive" formControlName="IsActive" />
                  <label for="IsActive" class="form-check-label">Active?</label>
                </div>
              </div>

              <div class="col-md-2 d-flex align-items-center">
                <div class="form-check form-switch">
                  <input type="checkbox" class="form-check-input" id="IsSubsidiary" formControlName="IsSubsidiary" />
                  <label for="IsSubsidiary" class="form-check-label">Subsidiary?</label>
                </div>
              </div>

              <div class="col-md-2 d-flex align-items-center">
                <div class="form-check form-switch">
                  <input type="checkbox" class="form-check-input" id="RedList" formControlName="RedList" />
                  <label for="RedList" class="form-check-label text-danger fw-semibold">Red List</label>
                </div>
              </div>

              <div class="col-md-2">
                <label class="form-label">Ranking</label>
                <div class="star-rating d-flex align-items-center">
                  <i *ngFor="let star of [1, 2, 3, 4, 5]" class="bi"
                    [ngClass]="{ 'bi-star-fill': registrationForm.get('Ranking')?.value >= star, 'bi-star': registrationForm.get('Ranking')?.value < star }"
                    (click)="registrationForm.patchValue({ Ranking: star })"
                    style="cursor: pointer; font-size: 1.2rem; color: #ffc107;"></i>
                  <span class="text-muted small ms-2">{{ registrationForm.get('Ranking')?.value }}/5</span>
                </div>
              </div>
            </div>

            <!-- Parent Vendor -->
<div class="col-md-12 mt-3" *ngIf="registrationForm.get('IsSubsidiary')?.value">
  <label class="form-label">Parent Vendor <span class="text-danger">*</span></label>
  <div class="parent-vendor-wrapper">
    <nz-tree-select
      formControlName="ParentVendorId"
      nzPlaceHolder="Search Parent Vendor..."
      [nzNodes]="parentVendorTree"
      [nzShowSearch]="true"
      [nzAllowClear]="true"
      [nzDropdownStyle]="{
        'max-height': 'calc(65vh - 250px)',
        'overflow-y': 'auto'
      }"
      style="width: 100%; height: 42px;">
    </nz-tree-select>
  </div>
</div>


          </div>
        </nz-tab>

        <!-- =================== CONTACT =================== -->
        <nz-tab nzTitle="Contact Information">
          <div class="tab-content">
            <h5 class="section-title">
              <i class="bi bi-person-lines-fill me-2 text-primary"></i> Contact Information
            </h5>

            <div class="row g-3 mt-2">
              <div class="col-md-6">
                <label class="form-label">Email <span class="text-danger">*</span></label>
                <input type="email" class="form-control" formControlName="ContactEmail"
                  placeholder="vendor@example.com" />
              </div>

              <div class="col-md-6">
                <label class="form-label">Phone <span class="text-danger">*</span></label>
                <input type="text" class="form-control" formControlName="ContactPhone" placeholder="e.g. 03001234567" />
              </div>

              <div class="col-md-12">
                <label class="form-label">Website</label>
                <input type="url" class="form-control" formControlName="ContactWebsite"
                  placeholder="https://example.com" />
              </div>
            </div>
          </div>
        </nz-tab>

        <!-- =================== ADDRESSES =================== -->
        <nz-tab nzTitle="Addresses">
        <div class="address-grid">

  <!-- BILLING ADDRESS -->
  <div class="address-card">
    <h5 class="section-title">Billing Address</h5>

    <div class="row g-3">
      <div class="col-md-12">
        <label class="form-label">Address Line 1 *</label>
        <input type="text" class="form-control" formControlName="billingAddressLine1" />
      </div>

      <div class="col-md-12">
        <label class="form-label">Address Line 2</label>
        <input type="text" class="form-control" formControlName="billingAddressLine2" />
      </div>

      <div class="col-md-6">
        <label class="form-label">Zone *</label>
        <nz-select formControlName="billingZoneId" nzPlaceHolder="Select Zone" class="w-100">
          <nz-option *ngFor="let z of zones" [nzValue]="z.id" [nzLabel]="z.name"></nz-option>
        </nz-select>
      </div>

      <div class="col-md-6">
        <label class="form-label">Country *</label>
        <nz-select formControlName="billingCountryId" nzPlaceHolder="Select Country" class="w-100">
          <nz-option *ngFor="let c of billingCountries" [nzValue]="c.id" [nzLabel]="c.name"></nz-option>
        </nz-select>
      </div>

      <div class="col-md-6">
        <label class="form-label">State *</label>
        <nz-select formControlName="billingStateId" nzPlaceHolder="Select State" class="w-100">
          <nz-option *ngFor="let s of billingStates" [nzValue]="s.id" [nzLabel]="s.name"></nz-option>
        </nz-select>
      </div>

      <div class="col-md-6">
        <label class="form-label">City *</label>
        <nz-select formControlName="billingCityId" nzPlaceHolder="Select City" class="w-100">
          <nz-option *ngFor="let c of billingCities" [nzValue]="c.id" [nzLabel]="c.name"></nz-option>
        </nz-select>
      </div>

      <div class="col-md-6">
        <label class="form-label">Zip Code *</label>
        <input type="text" class="form-control" formControlName="billingZipcode" />
      </div>
    </div>
  </div>


  <!-- SHIPPING ADDRESS -->
  <div class="address-card">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="section-title mb-0">Shipping Address</h5>

      <button type="button" class="btn btn-outline-primary btn-sm"
        (click)="copyBillingToShipping()">
    Same as Billing
      </button>
    </div>

    <div class="row g-3 mt-2">
      <div class="col-md-12">
        <label class="form-label">Address Line 1 *</label>
        <input type="text" class="form-control" formControlName="shippingAddressLine1" />
      </div>

      <div class="col-md-12">
        <label class="form-label">Address Line 2</label>
        <input type="text" class="form-control" formControlName="shippingAddressLine2" />
      </div>

      <div class="col-md-6">
        <label class="form-label">Zone *</label>
        <nz-select formControlName="shippingZoneId" nzPlaceHolder="Select Zone" class="w-100">
          <nz-option *ngFor="let z of zones" [nzValue]="z.id" [nzLabel]="z.name"></nz-option>
        </nz-select>
      </div>

      <div class="col-md-6">
        <label class="form-label">Country *</label>
        <nz-select formControlName="shippingCountryId" nzPlaceHolder="Select Country" class="w-100">
          <nz-option *ngFor="let c of shippingCountries" [nzValue]="c.id" [nzLabel]="c.name"></nz-option>
        </nz-select>
      </div>

      <div class="col-md-6">
        <label class="form-label">State *</label>
        <nz-select formControlName="shippingStateId" nzPlaceHolder="Select State" class="w-100">
          <nz-option *ngFor="let s of shippingStates" [nzValue]="s.id" [nzLabel]="s.name"></nz-option>
        </nz-select>
      </div>

      <div class="col-md-6">
        <label class="form-label">City *</label>
        <nz-select formControlName="shippingCityId" nzPlaceHolder="Select City" class="w-100">
          <nz-option *ngFor="let c of shippingCities" [nzValue]="c.id" [nzLabel]="c.name"></nz-option>
        </nz-select>
      </div>

      <div class="col-md-6">
        <label class="form-label">Zip Code *</label>
        <input type="text" class="form-control" formControlName="shippingZipcode" />
      </div>
    </div>
  </div>

</div>


           
        </nz-tab>


<!-- =================== COMPANY & DEPARTMENT =================== -->
<nz-tab nzTitle="ðŸ¢ Company & Department">
  <div class="enterprise-tab">
    <div class="tab-header">
      <div class="icon-wrap">
        <i class="bi bi-diagram-3-fill text-primary"></i>
      </div>
      <div>
        <h5 class="title">Company & Department Association</h5>
        <p class="subtitle">
          Manage how this vendor connects with internal divisions and client organizations.
        </p>
      </div>
    </div>

    <div class="row g-4 mt-3">
      <!-- Left side: Company & Department selection -->
      <div class="col-md-6 d-flex flex-column">
        <!-- Client Companies -->
        <div class="field-card mb-3">
          <div class="field-header">
            <i class="bi bi-building text-primary"></i>
            <label class="form-label">Client Companies</label>
          </div>
          <nz-tree-select
            formControlName="clientCompanyIds"
            nzPlaceHolder="Search or select companies"
            [nzNodes]="companyTree"
            [nzShowSearch]="true"
            [nzAllowClear]="true"
            [nzShowExpand]="true"
            (nzExpandChange)="onExpandChange($event, 'company')"
            nzMultiple
            [nzDropdownStyle]="{ 'max-height': '300px', 'overflow-y': 'auto' }"
            class="enterprise-select w-100"
          >
          </nz-tree-select>
        </div>

        <!-- Departments -->
        <div class="field-card">
          <div class="field-header">
            <i class="bi bi-people-fill text-success"></i>
            <label class="form-label">Departments</label>
          </div>
          <nz-tree-select
            formControlName="departmentIds"
            nzPlaceHolder="Search or select departments"
            [nzNodes]="departmentTree"
            [nzShowSearch]="true"
            [nzAllowClear]="true"
            [nzShowExpand]="true"
            (nzExpandChange)="onExpandChange($event, 'department')"
            nzMultiple
            [nzDropdownStyle]="{ 'max-height': '300px', 'overflow-y': 'auto' }"
            class="enterprise-select w-100"
          >
          </nz-tree-select>
        </div>
      </div>

      <!-- Right side: Display selected companies and departments -->
      <div class="col-md-6">
        <div class="summary-panel">
          <h6 class="summary-title">
            <i class="bi bi-layers me-1"></i> Associations Overview
          </h6>

          <!-- Display Selected Companies -->
          <div *ngIf="registrationForm.value.clientCompanyIds?.length">
            <b class="text-primary">Selected Companies:</b>
            <div class="tag-container" *ngFor="let id of registrationForm.value.clientCompanyIds">
              <div class="tag-chip company">
                <i class="bi bi-building me-1"></i>
                {{ getLabelById(id, 'company') }}
              </div>
            </div>
          </div>

          <!-- Display Selected Departments -->
          <div *ngIf="registrationForm.value.departmentIds?.length" class="mt-2">
            <b class="text-success">Selected Departments:</b>
            <div class="tag-container" *ngFor="let id of registrationForm.value.departmentIds">
              <div class="tag-chip department">
                <i class="bi bi-people-fill me-1"></i>
                {{ getLabelById(id, 'department') }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</nz-tab>




</nz-tabset>

  

      <div class="footer-bar" (click)="saveVendor()">
        @if (!isLoading && registrationForm.valid) {
        <span>
          <i class="bi {{ mode === 'update' ? 'bi-pencil-square' : 'bi-save' }} me-2"></i>
          {{ mode === 'update' ? 'Update Vendor' : 'Save Vendor' }}
        </span>
        } @else if (isLoading) {
        <span>
          <span class="spinner-border spinner-border-sm me-2"></span>
          Saving...
        </span>
        } @else {
        <span class="opacity-75">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Please fill all required fields
        </span>
        }
      </div>
    </form>
  </div>
</div>

<style>
  /* same parent vendor dropdown styling */
  .parent-vendor-wrapper {
    position: relative;
    width: 100%;
  }

  .parent-vendor-wrapper ::ng-deep .ant-select-selector {
    width: 100% !important;
  }

  .parent-vendor-wrapper ::ng-deep .ant-select-dropdown {
    width: 100% !important;
    left: 0 !important;
    right: 0 !important;
    max-width: none !important;
    border-radius: 6px !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
    padding: 4px 0 !important;
  }

  .cdk-overlay-container .ant-select-dropdown {
    width: 100vw !important;
    left: 0 !important;
    right: 0 !important;
    max-width: 100vw !important;
    border-radius: 0 !important;
    z-index: 1050 !important;
  }

  .cdk-overlay-container .ant-select-dropdown .ant-select-tree {
    max-height: 300px !important;
    overflow-y: auto !important;
  }











/* --- Enterprise Layout --- */
.enterprise-tab {
  padding: 1.5rem;
  background: #f9fbfd;
  border-radius: 12px;
  box-shadow: inset 0 0 0 1px #eef1f6;
}

.tab-header {
  display: flex;
  align-items: center;
  gap: 1rem;
  border-bottom: 1px solid #e4e7eb;
  padding-bottom: 0.75rem;
}

.icon-wrap {
  width: 42px;
  height: 42px;
  border-radius: 8px;
  background: linear-gradient(135deg, #1677ff20, #5cb0ff20);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.4rem;
}

.title {
  font-weight: 600;
  color: #222;
  margin-bottom: 0.25rem;
}

.subtitle {
  font-size: 0.9rem;
  color: #6c757d;
  margin: 0;
}

/* --- Input Card Style --- */
.field-card {
  background: #fff;
  border-radius: 10px;
  padding: 1rem 1.2rem;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
  transition: all 0.25s ease-in-out;
  border: 1px solid #eef1f6;
}

.field-card:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  transform: translateY(-1px);
}

.field-header {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.4rem;
  font-weight: 500;
}

/* --- Select Styling --- */
.enterprise-select .ant-select-selector {
  border-radius: 8px !important;
  min-height: 42px;
  border-color: #dce3ed !important;
  transition: all 0.25s ease;
}

.enterprise-select:hover .ant-select-selector {
  border-color: #1677ff !important;
  box-shadow: 0 0 0 3px rgba(22, 119, 255, 0.1);
}

.dropdown-add {
  padding: 6px 12px;
  cursor: pointer;
  transition: background 0.2s;
  font-weight: 500;
  border-top: 1px solid #eaeaea;
}

.dropdown-add:hover {
  background: #f4f9ff;
}

/* --- Tag Chips --- */
.tag-chip {
  display: inline-flex;
  align-items: center;
  border-radius: 16px;
  font-size: 0.85rem;
  padding: 4px 10px;
  margin-right: 6px;
  margin-bottom: 6px;
  color: #fff;
}

.tag-chip.company {
  background: linear-gradient(135deg, #1677ff, #5cb0ff);
}

.tag-chip.department {
  background: linear-gradient(135deg, #28a745, #6fd67a);
}

/* --- Summary Panel --- */
.summary-panel {
  background: #fff;
  border-radius: 10px;
  padding: 1rem 1.2rem;
  border: 1px solid #e6ebf1;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  animation: fadeIn 0.4s ease-in-out;
}

.summary-title {
  font-weight: 600;
  color: #333;
  margin-bottom: 0.8rem;
}

.hint {
  display: block;
  margin-top: 4px;
  font-size: 0.8rem;
  color: #8a8f99;
}

/* --- Subtle fade animation --- */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(5px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}


</style>
<h2 class="h5 mb-3">Leave Applications History</h2>

<!-- Search + Filter Row -->
<div class="d-flex justify-content-between mb-3 align-items-center">

  <!-- Search Input -->
  <input
    nz-input
    placeholder="Search leave type, reason, approver..."
    style="width: 250px;"
    [(ngModel)]="searchText"
    (ngModelChange)="onSearch($event)" />

  <!-- Status Filter -->
  <nz-select
    style="width: 200px;"
    nzAllowClear
    placeholder="Filter by Status"
    [(ngModel)]="statusFilter"
    (ngModelChange)="onFilterStatus($event)">
    <nz-option
      *ngFor="let s of statusOptions"
      [nzLabel]="s.label"
      [nzValue]="s.value">
    </nz-option>
  </nz-select>
</div>

<!-- Loading Spinner -->
<nz-spin *ngIf="isLoading" nzTip="Loading..."></nz-spin>

<!-- No Data -->
<div *ngIf="!isLoading && leaves.length === 0" class="text-center py-3 text-muted">
  No leave requests found.
</div>

<!-- Table -->
<nz-table
  *ngIf="!isLoading && leaves.length > 0"
  [nzData]="leaves"
  nzBordered
  nzFrontPagination="false"
  nzSize="middle">

  <thead>
    <tr>
      <th>#</th>

      <th nzColumnKey="status" nzSort nzSortKey="status" (nzSortChange)="handleSort($event)">
        Status
      </th>

      <th nzColumnKey="applyDate" nzSort nzSortKey="applyDate" (nzSortChange)="handleSort($event)">
        Apply Date
      </th>

      <th nzColumnKey="leaveType" nzSort nzSortKey="leaveType" (nzSortChange)="handleSort($event)">
        Leave Type
      </th>

      <th nzColumnKey="startDate" nzSort nzSortKey="startDate" (nzSortChange)="handleSort($event)">
        Start Date
      </th>

      <th nzColumnKey="endDate" nzSort nzSortKey="endDate" (nzSortChange)="handleSort($event)">
        End Date
      </th>

      <th>Reason</th>
      <th>Approver</th>
      <th>Actions</th>
    </tr>
  </thead>

  <tbody>
    <tr *ngFor="let leave of leaves; let i = index">
      <td>{{ (page - 1) * pageSize + i + 1 }}</td>

      <td>
        <nz-badge
          [nzStatus]="
            leave.status === 'Approved' ? 'success' :
            leave.status === 'Rejected' ? 'error' :
            leave.status === 'Cancelled' ? 'warning' :
            leave.status === 'Void' ? 'default' :
            'processing'
          "
          [nzText]="leave.status">
        </nz-badge>
      </td>

      <td>{{ leave.applyDate | date:'yyyy-MM-dd' }}</td>
      <td>{{ leave.leaveTypeName || leave.leaveType?.leaveTypeName }}</td>
      <td>{{ leave.startDate | date:'yyyy-MM-dd' }}</td>
      <td>{{ leave.endDate | date:'yyyy-MM-dd' }}</td>
      <td>{{ leave.leaveDescription }}</td>
      <td>{{ leave.approverName || '-' }}</td>

      <td>
        <button
          nz-button
          nzType="default"
          nzSize="small"
          nz-dropdown
          [nzDropdownMenu]="menu"
          (click)="selectedRow = leave">
          Actions
        </button>
      </td>
    </tr>
  </tbody>
</nz-table>

<!-- Pagination -->
<div class="d-flex justify-content-end mt-3">
  <nz-pagination
    [nzPageIndex]="page"
    [nzTotal]="totalCount"
    [nzPageSize]="pageSize"
    (nzPageIndexChange)="onPageChange($event)">
  </nz-pagination>
</div>

<!-- Dropdown Menu -->
<nz-dropdown-menu #menu="nzDropdownMenu">
  <ul nz-menu>
    <li nz-menu-item (click)="onMenu('open')">View Details</li>
    <li nz-menu-item (click)="onMenu('edit')">Edit</li>

    <li
      nz-menu-item
      *ngIf="canApprove"
      [nzDisabled]="selectedRow?.status === 'Approved'"
      (click)="onMenu('approve')">
      Approve
    </li>

    <li
      nz-menu-item
      *ngIf="canApprove"
      [nzDisabled]="selectedRow?.status === 'Rejected'"
      (click)="onMenu('reject')">
      Reject
    </li>

    <li nz-menu-item (click)="onMenu('copy')">Copy JSON</li>
  </ul>
</nz-dropdown-menu>

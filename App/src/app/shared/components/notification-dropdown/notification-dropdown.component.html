<c-dropdown [popperOptions]="{ placement: 'bottom-end' }" variant="nav-item">
  <button
    [caret]="false"
    cDropdownToggle
    class="py-0 pe-0 border-0 bg-transparent position-relative"
    aria-label="Notifications"
    (click)="loadNotifications()"
  >
    <svg cIcon class="my-1" name="cilBell" size="lg" ></svg>
    @if (unreadCount > 0) {
    <c-badge
      class="notification-badge position-absolute top-0 start-100 translate-middle"
      color="danger"
      shape="rounded-pill"
    >
      {{ unreadCount > 99 ? '99+' : unreadCount }}
    </c-badge>
    }
  </button>

  <div
    cDropdownMenu
    class="notification-dropdown-menu"
    style="min-width: 380px; max-width: 400px"
  >
    <!-- Header -->
    <div class="dropdown-header d-flex justify-content-between align-items-center p-3 border-bottom">
      <h6 class="mb-0 fw-semibold">Notifications</h6>
      @if (unreadCount > 0) {
      <button
        class="btn btn-sm btn-link text-decoration-none p-0"
        (click)="markAllAsRead()"
      >
        Mark all read
      </button>
      }
    </div>

    <!-- Loading State -->
    @if (loading) {
    <div class="text-center py-5">
      <div class="spinner-border spinner-border-sm text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="text-muted mt-2 mb-0 small">Loading notifications...</p>
    </div>
    }

    <!-- Notifications List -->
    @if (!loading && notifications.length > 0) {
    <div class="notification-list" style="max-height: 400px; overflow-y: auto">
      @for (notification of notifications; track notification.id) {
      <a
        cDropdownItem
        class="notification-item"
        [class]="getNotificationClass(notification)"
        (click)="onNotificationClick(notification)"
        style="cursor: pointer"
      >
        <div class="d-flex align-items-start gap-3 p-2">
          <!-- Icon -->
          <div class="notification-icon">
            <svg
              cIcon
              [name]="getNotificationIcon(notification)"
              size="lg"
              [class.text-primary]="!notification.isRead"
              [class.text-muted]="notification.isRead"
            ></svg>
          </div>

          <!-- Content -->
          <div class="flex-grow-1">
            <div class="d-flex justify-content-between align-items-start mb-1">
              <h6
                class="notification-title mb-1"
                [class.fw-bold]="!notification.isRead"
                [class.fw-normal]="notification.isRead"
              >
                {{ notification.title }}
              </h6>
              @if (!notification.isRead) {
              <span class="badge bg-primary rounded-circle p-1" style="width: 8px; height: 8px"></span>
              }
            </div>

            @if (notification.description) {
            <p class="notification-description text-muted small mb-1">
              {{ notification.description }}
            </p>
            }

            <div class="d-flex justify-content-between align-items-center mt-2">
              <small class="text-muted">
                {{ getTimeAgo(notification.timestamp) }}
              </small>

              @if (notification.notificationFlag) {
              <span
                class="badge"
                [style.background-color]="notification.notificationFlag.backColor"
                [style.color]="'#fff'"
              >
                {{ notification.notificationFlag.flag }}
              </span>
              }
            </div>
          </div>

          <!-- Mark as read button -->
          @if (!notification.isRead) {
          <button
            class="btn btn-sm btn-link text-muted p-0"
            (click)="markAsRead(notification, $event)"
            title="Mark as read"
          >
            <svg cIcon name="cilCheckCircle" size="sm"></svg>
          </button>
          }
        </div>
      </a>
      }
    </div>
    }

    <!-- Empty State -->
    @if (!loading && notifications.length === 0) {
    <div class="text-center py-5 px-3">
      <svg
        cIcon
        name="cilBellSlash"
        size="3xl"
        class="text-muted mb-3"
      ></svg>
      <p class="text-muted mb-0">No notifications</p>
      <small class="text-muted">You're all caught up!</small>
    </div>
    }

    <!-- Footer -->
    <div class="dropdown-footer border-top p-2 text-center">
      <button
        class="btn btn-link text-decoration-none w-100"
        (click)="viewAllNotifications()"
      >
        View all notifications
      </button>
    </div>
  </div>
</c-dropdown>
